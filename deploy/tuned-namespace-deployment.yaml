apiVersion: apps/v1
kind: Deployment
metadata:
  name: tuned-viewer
  namespace: openshift-cluster-node-tuning-operator
  labels:
    app.kubernetes.io/name: tuned-viewer
    app.kubernetes.io/component: analyzer
    app.kubernetes.io/part-of: node-tuning-operator
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: tuned-viewer
      app.kubernetes.io/component: analyzer

  template:
    metadata:
      labels:
        app.kubernetes.io/name: tuned-viewer
        app.kubernetes.io/component: analyzer
        app.kubernetes.io/part-of: node-tuning-operator
    spec:
      serviceAccountName: tuned  # Use existing tuned service account

      containers:
      - name: tuned-viewer
        image: quay.io/bzhai/tuned-viewer:latest
        imagePullPolicy: Always

        # Keep container running for interactive use
        command: ["/bin/sh"]
        args:
          - -c
          - |
            echo "Tuned Viewer running in tuned namespace"
            echo "======================================="

            # Show initial status
            echo "Environment:"
            python3 -m tuned_viewer env
            echo ""

            echo "Available profiles:"
            python3 -m tuned_viewer list
            echo ""

            echo "Cluster status:"
            python3 -m tuned_viewer cluster
            echo ""

            echo "Ready for analysis commands:"
            echo "  oc exec -it deployment/tuned-viewer -n openshift-cluster-node-tuning-operator -- python3 -m tuned_viewer cluster"
            echo "  oc exec -it deployment/tuned-viewer -n openshift-cluster-node-tuning-operator -- python3 -m tuned_viewer sync"
            echo ""

            # Keep running for interactive access
            while true; do
              echo "$(date): Tuned viewer ready for analysis"
              sleep 300
            done

        env:
        - name: KUBERNETES_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name

        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "200m"

        volumeMounts:
        - name: analysis-storage
          mountPath: /app/cluster_profiles

        # Health check
        livenessProbe:
          exec:
            command:
            - python3
            - -m
            - tuned_viewer
            - env
          initialDelaySeconds: 30
          periodSeconds: 120

        readinessProbe:
          exec:
            command:
            - python3
            - -c
            - "import tuned_viewer"
          initialDelaySeconds: 5
          periodSeconds: 10

      volumes:
      - name: analysis-storage
        emptyDir:
          sizeLimit: 1Gi

      # Run on any worker node
      nodeSelector:
        kubernetes.io/os: linux

      tolerations:
      - operator: "Exists"

      # Prefer worker nodes
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: node-role.kubernetes.io/worker
                operator: Exists