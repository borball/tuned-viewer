apiVersion: apps/v1
kind: Deployment
metadata:
  name: tuned-viewer
  namespace: tuned-viewer
  labels:
    app.kubernetes.io/name: tuned-viewer
    app.kubernetes.io/component: analysis-tool
    app.kubernetes.io/instance: service
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: tuned-viewer
      app.kubernetes.io/instance: service

  template:
    metadata:
      labels:
        app.kubernetes.io/name: tuned-viewer
        app.kubernetes.io/component: analysis-tool
        app.kubernetes.io/instance: service
    spec:
      serviceAccountName: tuned-viewer

      containers:
      - name: tuned-viewer
        image: tuned-viewer:latest
        imagePullPolicy: IfNotPresent

        # Keep container running for interactive use
        command: ["/bin/sh"]
        args:
          - -c
          - |
            echo "Tuned Viewer service is ready"
            echo "Use 'oc exec' to run tuned-viewer commands"
            echo ""
            echo "Examples:"
            echo "  oc exec -it deployment/tuned-viewer -- python3 -m tuned_viewer cluster"
            echo "  oc exec -it deployment/tuned-viewer -- python3 -m tuned_viewer sync"
            echo "  oc exec -it deployment/tuned-viewer -- python3 -m tuned_viewer node <node-name>"
            echo ""

            # Run periodic cluster status checks
            while true; do
              echo "$(date): Running periodic cluster status check..."
              python3 -m tuned_viewer cluster > /tmp/cluster-status.log 2>&1 || true
              sleep 300  # Check every 5 minutes
            done

        env:
        - name: KUBERNETES_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName

        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "200m"

        volumeMounts:
        - name: profiles-storage
          mountPath: /app/cluster_profiles
        - name: tmp
          mountPath: /tmp

        # Health check using the built-in env command
        livenessProbe:
          exec:
            command:
            - python3
            - -m
            - tuned_viewer
            - env
          initialDelaySeconds: 30
          periodSeconds: 60
          timeoutSeconds: 10

        readinessProbe:
          exec:
            command:
            - python3
            - -c
            - "import sys; sys.exit(0)"
          initialDelaySeconds: 5
          periodSeconds: 10

      volumes:
      - name: profiles-storage
        emptyDir:
          sizeLimit: 1Gi
      - name: tmp
        emptyDir: {}

      # Tolerate running on any node, but prefer worker nodes
      tolerations:
      - operator: "Exists"

      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: node-role.kubernetes.io/worker
                operator: Exists