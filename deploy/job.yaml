apiVersion: batch/v1
kind: Job
metadata:
  name: tuned-viewer-analysis
  namespace: tuned-viewer
  labels:
    app.kubernetes.io/name: tuned-viewer
    app.kubernetes.io/component: analysis-job
    app.kubernetes.io/instance: batch
spec:
  backoffLimit: 3
  completions: 1
  parallelism: 1

  template:
    metadata:
      labels:
        app.kubernetes.io/name: tuned-viewer
        app.kubernetes.io/component: analysis-job
        app.kubernetes.io/instance: batch
    spec:
      serviceAccountName: tuned-viewer
      restartPolicy: Never

      containers:
      - name: analyzer
        image: quay.io/bzhai/tuned-viewer:latest
        imagePullPolicy: Always

        command: ["/bin/sh"]
        args:
          - -c
          - |
            set -e

            echo "==================================="
            echo "Tuned Profile Cluster Analysis Job"
            echo "==================================="
            echo ""

            # 1. Show environment information
            echo "1. Environment Information"
            echo "--------------------------"
            python3 -m tuned_viewer env
            echo ""

            # 2. Show cluster tuned status
            echo "2. Cluster Tuned Status"
            echo "----------------------"
            python3 -m tuned_viewer cluster
            echo ""

            # 3. Sync all profiles from cluster
            echo "3. Syncing Profiles from Cluster"
            echo "--------------------------------"
            python3 -m tuned_viewer sync --output-dir /tmp/cluster_profiles
            echo ""

            # 4. Analyze each node's profile
            echo "4. Per-Node Profile Analysis"
            echo "----------------------------"

            # Get all nodes and analyze their profiles
            nodes=$(oc get nodes --no-headers -o custom-columns=NAME:.metadata.name)
            for node in $nodes; do
              echo ""
              echo "Analyzing node: $node"
              echo "$(printf '=%.0s' {1..40})"
              python3 -m tuned_viewer node "$node" --format summary || echo "Failed to analyze $node"
              echo ""
            done

            # 5. Generate cluster-wide report
            echo "5. Cluster Profile Summary"
            echo "-------------------------"
            echo "Analysis completed at: $(date)"

            echo ""
            echo "Profile files synced to: /tmp/cluster_profiles"
            echo "Job logs available via: oc logs job/tuned-viewer-analysis"

        env:
        - name: KUBERNETES_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace

        resources:
          requests:
            memory: "128Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "1000m"

        volumeMounts:
        - name: analysis-output
          mountPath: /tmp/cluster_profiles

      volumes:
      - name: analysis-output
        emptyDir:
          sizeLimit: 2Gi

      # Allow running on any node
      tolerations:
      - operator: "Exists"

  # Keep job pods for 1 hour after completion for log inspection
  ttlSecondsAfterFinished: 3600