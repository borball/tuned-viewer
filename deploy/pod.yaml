apiVersion: v1
kind: Pod
metadata:
  name: tuned-viewer
  namespace: tuned-viewer
  labels:
    app.kubernetes.io/name: tuned-viewer
    app.kubernetes.io/component: analysis-tool
    app.kubernetes.io/instance: standalone
spec:
  serviceAccountName: tuned-viewer
  restartPolicy: Never

  containers:
  - name: tuned-viewer
    image: quay.io/bzhai/tuned-viewer:latest
    imagePullPolicy: Always

    # Override default command to run cluster analysis
    command: ["/bin/sh"]
    args:
      - -c
      - |
        echo "Starting tuned profile analysis..."
        echo "================================"

        # Show environment info
        echo "Environment Information:"
        python3 -m tuned_viewer env
        echo ""

        # Show cluster status
        echo "Cluster Status:"
        python3 -m tuned_viewer cluster
        echo ""

        # Sync profiles from cluster
        echo "Syncing profiles from cluster..."
        python3 -m tuned_viewer sync --output-dir /tmp/cluster_profiles
        echo ""

        # Analyze profiles from the first running node
        first_node=$(oc get nodes --no-headers | head -n1 | awk '{print $1}')
        if [ -n "$first_node" ]; then
          echo "Analyzing profile for node: $first_node"
          python3 -m tuned_viewer node $first_node
        fi

        echo "Analysis complete. Pod will remain running for log inspection."
        echo "Use 'oc logs tuned-viewer -n tuned-viewer' to view results."

        # Keep pod running for log inspection
        sleep 3600

    env:
    - name: KUBERNETES_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name

    resources:
      requests:
        memory: "64Mi"
        cpu: "100m"
      limits:
        memory: "256Mi"
        cpu: "500m"

    volumeMounts:
    - name: tmp
      mountPath: /tmp

  volumes:
  - name: tmp
    emptyDir: {}

  # Tolerate running on any node
  tolerations:
  - operator: "Exists"